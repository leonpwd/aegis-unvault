name: Manual Release

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  RUST_BACKTRACE: 1
  PCRE2_SYS_STATIC: 1

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --tags

      - name: Compute next version (Conventional Commits)
        id: version
        run: |
          latest_tag=$(git tag --list 'v*' --sort=-v:refname | head -n 1)

          if [[ -z "$latest_tag" ]]; then
            new_tag="v0.1.0"
          else
            version=${latest_tag#v}
            IFS='.' read -r major minor patch <<< "$version"

            commits=$(git log $latest_tag..HEAD --pretty=format:'%s')
            bump="patch"

            while IFS= read -r msg; do
              if [[ "$msg" =~ BREAKING\ CHANGE ]] || [[ "$msg" =~ \! ]]; then
                bump="major"; break
              elif [[ "$msg" =~ ^feat ]]; then
                bump="minor"
              fi
            done <<< "$commits"

            if [[ "$bump" == "major" ]]; then
              major=$((major+1)); minor=0; patch=0
            elif [[ "$bump" == "minor" ]]; then
              minor=$((minor+1)); patch=0
            else
              patch=$((patch+1))
            fi

            new_tag="v$major.$minor.$patch"
          fi

          echo "tag=$new_tag" >> $GITHUB_OUTPUT

      - name: Create tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}

      - name: Generate changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --latest
        env:
          OUTPUT: BODY.md

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GH_PAT }}
          tag: ${{ steps.version.outputs.tag }}
          bodyFile: BODY.md
          prerelease: false

  build:
    needs: prepare-release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            os-name: macos
            arch: arm64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            os-name: linux
            arch: x86_64

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust target
        run: rustup target add ${{ matrix.target }}

      - name: Install dependencies for Linux
        if: matrix.os-name == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libcairo2-dev libglib2.0-dev libgtk-3-dev

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package
        run: |
          mkdir -p dist
          BIN=target/${{ matrix.target }}/release/aegis-unvault
          cp $BIN dist/
          cd dist
          tar -czf aegis-unvault-${{ matrix.os-name }}-${{ matrix.arch }}-${{ needs.prepare-release.outputs.tag }}.tar.gz aegis-unvault
          rm aegis-unvault

      - name: Upload asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag }}
          files: dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-tap:
    needs: [prepare-release, build]
    runs-on: ubuntu-latest

    steps:
      - name: Set tag and version
        run: |
          TAG=${{ needs.prepare-release.outputs.tag }}
          if [[ "$TAG" != v* ]]; then TAG="v$TAG"; fi
          VERSION=${TAG#v}
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Wait for release assets
        run: |
          set -euo pipefail
          API_URL="https://api.github.com/repos/leonpwd/aegis-unvault/releases/tags/${{ env.TAG }}"
          tries=0
          MAX_TRIES=24
          SLEEP_SECONDS=10
          while [ $tries -lt $MAX_TRIES ]; do
            RELEASE_JSON=$(curl -s "$API_URL" ) || RELEASE_JSON=""
            MACOS_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[]? | select(.name | test("macos"; "i")) | .browser_download_url' | head -n1 || true)
            LINUX_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[]? | select(.name | test("linux"; "i")) | .browser_download_url' | head -n1 || true)
            if [ -n "$MACOS_URL" ] && [ -n "$LINUX_URL" ]; then
              echo "Found assets after $tries tries"
              break
            fi
            tries=$((tries+1))
            echo "Assets not yet available (try $tries/$MAX_TRIES), sleeping ${SLEEP_SECONDS}s..."
            sleep $SLEEP_SECONDS
          done
          if [ -z "$MACOS_URL" ] || [ -z "$LINUX_URL" ]; then
            echo "Timed out waiting for release assets for ${TAG}" >&2
            exit 1
          fi
          echo "MACOS_URL=$MACOS_URL" >> $GITHUB_ENV
          echo "LINUX_URL=$LINUX_URL" >> $GITHUB_ENV

      - name: Download assets and compute sha256
        run: |
          curl -L -o macos.tar.gz "${MACOS_URL}"
          curl -L -o linux.tar.gz "${LINUX_URL}"
          if command -v sha256sum >/dev/null 2>&1; then
            MACOS_SHA=$(sha256sum macos.tar.gz | cut -d ' ' -f1)
            LINUX_SHA=$(sha256sum linux.tar.gz | cut -d ' ' -f1)
          else
            MACOS_SHA=$(shasum -a 256 macos.tar.gz | awk '{print $1}')
            LINUX_SHA=$(shasum -a 256 linux.tar.gz | awk '{print $1}')
          fi
          echo "MACOS_SHA=$MACOS_SHA" >> $GITHUB_ENV
          echo "LINUX_SHA=$LINUX_SHA" >> $GITHUB_ENV

      - name: Checkout tap repo
        uses: actions/checkout@v4
        with:
          repository: leonpwd/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap

      - name: Update formula
        run: |
          cd tap
          # update version without leading v
          sed -i "s/version \".*\"/version \"${{ env.VERSION }}\"/" aegis-unvault.rb
          perl -0777 -pe 's|(url\s*".*macos.*arm.*"\n\s*sha256\s*")[^"]*(")|$1.$ENV{MACOS_SHA}.$2|ge' -i aegis-unvault.rb
          perl -0777 -pe 's|(url\s*".*linux.*x86_64.*"\n\s*sha256\s*")[^"]*(")|$1.$ENV{LINUX_SHA}.$2|ge' -i aegis-unvault.rb

      - name: Commit & push
        run: |
          cd tap
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add aegis-unvault.rb
          git commit -m "Update aegis-unvault to ${TAG}" || echo "No changes"
          git push